---
layout: post
title:  "With절에 대하여"
date:   2024-02-06 21:06:18 +0900
categories: jekyll update
---
WITH절은 서브쿼리를 별도로 빼내서 이름을 지어주는 기능을 합니다

여러번 쓰이는 서브쿼리를 따로 빼서 WITH절로 정의 해둘때 WITH절을 사용합니다

서브쿼리를 직접 쓰는것과 같은 결과값이 나오지만

그만큼 쿼리의 라인수가 짧아지고 가독성도 높아집니다

WITH절을 사용하는 방법은 다음과 같습니다

{% highlight ruby %}
WITH JINYOUNG AS
(
   SELECT '잘생겼습니다' FROM DUAL
)

{% endhighlight %}

이렇게 WITH 절을 만들어 놓으면

SELECT * FROM JINYOUNG; 을 쳤을때

잘생겼습니다 라고 나옵니다

한번만 쓰고 마는 서브쿼리를 WITH절로 정의해 두는 경우는 드뭅니다

여러번 사용되는 서브쿼리를 WITH절로 정의해 두는 경우가 많습니다

두번 이상 사용되는 WITH절은 그 결과값이 temp  영역에 따로 저장이 되기 때문에

서브쿼리의 결과값을 구하는데에 데이터량이 많고 내부적으로 복잡한 계산이 이루어져야 한다면

처음에 리소스가 많이 소모되더라도 temp 영역을 사용해서 저장을 해두는 것이 좋습니다.

하지만 서브쿼리에 쓰인 테이블의 데이터량이 적고 결과값을 도출하는 데에도 그다지 비용이 들지 않는다

라고 했을때는 오히려 temp 영역에 소모되는 리소스가 더 커져버릴 수 있습니다

그럴때는 굳이 WITH절로 빼지 않고 그냥 서브쿼리를 반복해서 작성해주는 것이 성능상 더 유리할 수도 있습니다

왜냐하면 temp 영역에 저장하기 위해서는 disk i/o 가 발생하기 때문입니다

여기서 disk i/o 란 데이터베이스가 데이터를 읽거나 쓸 때 발생하는 작업을 말합니다

이런 이유 때문에 오라클에서는 12.2 버전부터 WITH절의 결과값을 바로 TEMP 영역에 저장하지 않고

PGA영역에 한 번 올린 다음에 용량이 모자라다 할 때에만 temp 영역을 쓰는 방식을 도입했습니다

(여기서 PGA 영역이란 데이터베이스가 사용하는 메모리 영역으로 SQL문 및 트랙잭션에 필요한 메모리를 제어하는데 사용됩니다)
